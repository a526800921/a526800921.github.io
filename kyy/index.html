<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>背景 | 项目文档</title>
    <meta name="description" content="项目文档">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.495fb3d6.css" as="style"><link rel="preload" href="/assets/js/app.a79f5426.js" as="script"><link rel="preload" href="/assets/js/2.1fbd1c76.js" as="script"><link rel="preload" href="/assets/js/8.ed75f2d5.js" as="script"><link rel="prefetch" href="/assets/js/10.06005cdb.js"><link rel="prefetch" href="/assets/js/11.4e950798.js"><link rel="prefetch" href="/assets/js/12.b406d258.js"><link rel="prefetch" href="/assets/js/3.5a23f80c.js"><link rel="prefetch" href="/assets/js/4.90160e26.js"><link rel="prefetch" href="/assets/js/5.75c2e8ec.js"><link rel="prefetch" href="/assets/js/6.d929c0c2.js"><link rel="prefetch" href="/assets/js/7.2210c711.js"><link rel="prefetch" href="/assets/js/9.b885d552.js">
    <link rel="stylesheet" href="/assets/css/0.styles.495fb3d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">项目文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/guide/" class="sidebar-link">指南</a></li><li><a href="/npm/" class="sidebar-link">npm包</a></li><li><a href="/h5/" class="sidebar-link">H5</a></li><li><a href="/mp/" class="sidebar-link">小程序</a></li><li><a href="/kyy/" class="active sidebar-link">快应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kyy/#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/kyy/#开始" class="sidebar-link">开始</a></li><li class="sidebar-sub-header"><a href="/kyy/#初步设想" class="sidebar-link">初步设想</a></li><li class="sidebar-sub-header"><a href="/kyy/#生命周期驱动" class="sidebar-link">生命周期驱动</a></li><li class="sidebar-sub-header"><a href="/kyy/#useconnect" class="sidebar-link">useConnect</a></li><li class="sidebar-sub-header"><a href="/kyy/#usepage-usecomponent" class="sidebar-link">usePage useComponent</a></li><li class="sidebar-sub-header"><a href="/kyy/#usecomputed" class="sidebar-link">useComputed</a></li><li class="sidebar-sub-header"><a href="/kyy/#usewatch" class="sidebar-link">useWatch</a></li><li class="sidebar-sub-header"><a href="/kyy/#usestore" class="sidebar-link">useStore</a></li><li class="sidebar-sub-header"><a href="/kyy/#usestat" class="sidebar-link">useStat</a></li><li class="sidebar-sub-header"><a href="/kyy/#usewebview" class="sidebar-link">useWebview</a></li><li class="sidebar-sub-header"><a href="/kyy/#实用工具" class="sidebar-link">实用工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kyy/#addhook-gethook" class="sidebar-link">addHook getHook</a></li><li class="sidebar-sub-header"><a href="/kyy/#adddispatchqueue" class="sidebar-link">addDispatchQueue</a></li></ul></li><li class="sidebar-sub-header"><a href="/kyy/#关于配置" class="sidebar-link">关于配置</a></li><li class="sidebar-sub-header"><a href="/kyy/#结语" class="sidebar-link">结语</a></li></ul></li><li><a href="/other/" class="sidebar-link">其他</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>当时快应用处于各个厂商推荐时期，所以公司也在这方面尝试一下，
但快应用项目却是早早的就已经创建了并且有了基本功能，所以之后的快应用都是基于早期版本开发，
早期的快应用也跟小程序一样，几乎没有框架，状态管理困难，埋点更加困难，开发超级困难。。。</p> <p>但是没有时间来改(还是需要产品测试参与)，旧版的就不提了，说说重构版本。
重构版本是自己搭的一套增强型框架，使用原生语法(第三方在快应用上面不好使)。</p> <div class="custom-block warning"><p class="custom-block-title">旧版</p> <p>项目地址：mi-app</p> <p>这里需要注意一下分支：</p> <ul><li>merge-2 书香、即阅 通用模块分支，在有相同需求的时候在这个分支上修改，修改完成后合并到 书香 和 即阅分支</li> <li>jiyue_July 书香分支，书香单独需求时在这个分支上修改</li> <li>jiyue_new 即阅分支，即阅单独需求在这个分支上修改</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">新版</p> <p>项目地址：sx_quick_app</p> <p>这里也需要注意一下分支：</p> <ul><li>merge 书香、即阅、墨香 通用模块分支，在有相同需求的时候在这个分支上修改，修改完成后合并到 书香、即阅、墨香 分支</li> <li>sx_2.x 书香分支，书香单独需求在这个分支上修改</li> <li>jy_2.x 即阅分支，即阅单独需求在这个分支上修改（但即阅目前没有重构的需求，有需求的时候只需要修改对应的配置即可，下面会讲到）</li> <li>mx_2.x 墨香分支，墨香单独需求在这个分支上修改</li></ul></div> <div class="custom-block danger"><p class="custom-block-title">关于分支</p> <p>在这里着重说明一下分支的使用，因不同项目使用同一套代码，所以通过不同分支做区分，</p> <p>如果有新需求，如果是所有包都需要的需求，那就可以直接在 merge 分支上进行需求跟进；</p> <p>如果是单独一个包的需求，一定要在 merge 分支上再拉取一个分支出来进行需求跟进，然后合并到对应的包，例如 sx_1.6.0 sx_1.6.1 这类分支，
其实都是书香单独的需求，所以单独拉取分支出来单独合并，一定要这么做！</p></div> <h2 id="开始"><a href="#开始" class="header-anchor">#</a> 开始</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> 
    usePage<span class="token punctuation">,</span> useComponent<span class="token punctuation">,</span> useConnect<span class="token punctuation">,</span> useWatch<span class="token punctuation">,</span> useComputed<span class="token punctuation">,</span> useStore<span class="token punctuation">,</span> useStat<span class="token punctuation">,</span> useWebview<span class="token punctuation">,</span>
    $store<span class="token punctuation">,</span> $router<span class="token punctuation">,</span> $native<span class="token punctuation">,</span> $utils<span class="token punctuation">,</span> $stat<span class="token punctuation">,</span> $nodeStat<span class="token punctuation">,</span> $third<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">useConnect</span><span class="token punctuation">(</span>
    <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token string">'Root'</span><span class="token punctuation">,</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> state<span class="token punctuation">.</span>test
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">usePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            test2<span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>这里会一个一个讲解，先讲思路</p> <h2 id="初步设想"><a href="#初步设想" class="header-anchor">#</a> 初步设想</h2> <p>快应用的语法 小程序的语法 其实都是跟 vue 差不多的，但是又欠缺了 vue 的部分功能，
又不能像 react 那样函数式组件没有什么局限，所以需要对功能进行扩展，
在 vue 中比较好用的就是 computed 和 watch，那么就需要对这两个功能进行支持。
因为快应用自身是 getter setter 的语法，所以这里其实不好去做一层代理，
于是就新增一个赋值的方法 setData</p> <blockquote><p>文件 render/setData.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">setData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新的值的数组</span>
    <span class="token keyword">const</span> updates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span> updates

    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检测新值与旧值是否有更改</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">change</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            updates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                key<span class="token punctuation">,</span>
                oldValue<span class="token operator">:</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
                newValue<span class="token operator">:</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> updates
<span class="token punctuation">}</span>
</code></pre></div><p>在这里我就可以拿到返回的 updates ，来做 computed 的更新及 watch 的触发，其实也相当于是一个订阅更新的操作。</p> <p>那么最初的想法就已经实现了？</p> <h2 id="生命周期驱动"><a href="#生命周期驱动" class="header-anchor">#</a> 生命周期驱动</h2> <p>在写框架的时候，比如这个 setData 我需要注入到页面实例中，那么必然的我就会使用代理，
来达到所有页面都能使用的目的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> onInit <span class="token punctuation">}</span> <span class="token operator">=</span> page

page<span class="token punctuation">.</span><span class="token function-variable function">onInit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>setData <span class="token operator">=</span> setData

    <span class="token keyword">return</span> onInit <span class="token operator">&amp;&amp;</span> <span class="token function">onInit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是显然，连 setData 这一个方法都需要代理，那如果有其他增强是不是也需要代理？
如果都要代理，那代码可读性是不是非常低？各类代理是否会有执行顺序问题？</p> <p>为了解决这个问题，我统一在一个文件中进行代理，
通过权重(具体见源码)的方式控制顺序，通过遍历的方式顺序执行回调，抛出一个添加生命周期方法，
从而达到增强可读性，降低复杂性的目的，也解决了顺序调用的问题。</p> <blockquote><p>文件 render/lifecycle.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> onInit <span class="token punctuation">}</span> <span class="token operator">=</span> page

params<span class="token punctuation">.</span><span class="token function-variable function">onInit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在这里统一执行回调</span>
    <span class="token function">runHooks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'onInit'</span><span class="token punctuation">,</span> <span class="token operator">...</span>arg<span class="token punctuation">)</span>

    <span class="token keyword">return</span> onInit <span class="token operator">&amp;&amp;</span> <span class="token function">onInit</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这是添加生命周期的方法</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">addLifecycle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> interdict <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
</code></pre></div><p>在这个时候，一个非常实用的api就成了。那么我只需要这样使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 现在就变得优雅又简单了</span>
<span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onInit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>setData <span class="token operator">=</span> <span class="token function">setData</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>那么就可以进行其他功能的完善了，就从 开始 中的功能一个个叙述。</p> <h2 id="useconnect"><a href="#useconnect" class="header-anchor">#</a> useConnect</h2> <blockquote><p>文件 render/connect.js</p></blockquote> <p>这个方法是想到了 redux 的 connect 方法，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">connect</span><span class="token punctuation">(</span>mapState<span class="token punctuation">,</span> mapDispatch<span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span>
</code></pre></div><p>那通过 connect 的方式来连接增强功能与页面，可以达到类似插件的效果(解耦，按需使用，可读性好)，
至于我为什么把 usePage 放里面，因为放外面不好看。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里因为传入参数顺序不定，数量不定，所以需要进行一个区分</span>
<span class="token comment">// 比如 useStore 会返回一个 { type: 'useStore', use(params) { ... } }</span>
<span class="token comment">// 没有返回的就默认为 page/component</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">const</span> params <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>item<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> useStores <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'useStore'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> useComputed <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'useComputed'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> useWatch <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'useWatch'</span><span class="token punctuation">)</span>

    <span class="token comment">// 通过将 page/componet 对象传递给需要的模块，以引用的特性来进行修改</span>
    <span class="token comment">// 有执行顺序</span>
    useStores<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    useComputed <span class="token operator">&amp;&amp;</span> useComputed<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    useWatch <span class="token operator">&amp;&amp;</span> useWatch<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

    <span class="token comment">// 这里是对外进行的一个扩展，例如 useWebview</span>
    queue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> params
<span class="token punctuation">}</span>
</code></pre></div><p>那这里一个 useConnect 就完成了，接下来就是完成其他增强功能了</p> <h2 id="usepage-usecomponent"><a href="#usepage-usecomponent" class="header-anchor">#</a> usePage useComponent</h2> <blockquote><p>文件 render/page.js</p></blockquote> <blockquote><p>文件 render/component.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这就是全部代码了，useComponent也是一样的</span>
<span class="token comment">// 这里也是一样通过导出添加回调的方式进行解耦(大部分都可以这么做)</span>
<span class="token comment">// 主要给自定生命周期(文件 render/lifecycle.js)使用</span>
<span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">_Page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理数据</span>
  hooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// 页面类型</span>
  params<span class="token punctuation">.</span><span class="token function-variable function">getConnectType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'usePage'</span>

  <span class="token keyword">return</span> params
<span class="token punctuation">}</span>

_Page<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token parameter">fn</span> <span class="token operator">=&gt;</span> hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> 
<span class="token keyword">export</span> <span class="token keyword">default</span> _Page
</code></pre></div><h2 id="usecomputed"><a href="#usecomputed" class="header-anchor">#</a> useComputed</h2> <blockquote><p>文件 render/computed.js</p></blockquote> <p>计算属性，使用与 vue 几乎一致，接收一个对象作为参数，对象值为函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">useComputed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xxx
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>该方法在调用的时候会将对象中的key值注入到 page/component 的 data 参数中去(为了触发页面渲染，见源码)，
然后将计算规则绑定到当前 page/component 上面，得以在运行时可以使用当前实例 this。
导出一个 update 的方法，在 setData 使用的时候，进行更新的操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 方法接收一个来自 setData 更新后改变的值得数组</span>
<span class="token comment">// 然后进行计算(就是执行传入的key对应的函数)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">updates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> computedUpdates <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getComputedParams <span class="token operator">?</span> <span class="token function">setComputed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getComputedParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> repeat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// 拿真的旧值和最后的新值</span>
    computedUpdates<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repeat<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> repeat<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> oldValue<span class="token operator">:</span> item<span class="token punctuation">.</span>oldValue<span class="token punctuation">,</span> newValue<span class="token operator">:</span> item<span class="token punctuation">.</span>newValue <span class="token punctuation">}</span>
        <span class="token keyword">else</span> repeat<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>newValue <span class="token operator">=</span> item<span class="token punctuation">.</span>newValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> realUpdates <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>repeat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">,</span> <span class="token operator">...</span>repeat<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 计算完成后给 useWatch 使用</span>
    update<span class="token punctuation">.</span>listener <span class="token operator">&amp;&amp;</span> update<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> updates<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>realUpdates<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是在这里是没有做像 vue 那样的缓存结果属性的，需要的话通过代理一层 this 来达到相同的效果。</p> <h2 id="usewatch"><a href="#usewatch" class="header-anchor">#</a> useWatch</h2> <blockquote><p>文件 render/watch.js</p></blockquote> <p>监听，用法与 vue 几乎一致，附加功能支持到 immediate</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">useWatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'test2'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里思路很简单，就是拿到 setData 和 computed 的 updates ，然后遍历一遍 key，
然后执行对应 watch key 的方法就行了。</p> <div class="language-js extra-class"><pre class="language-js"><code>updates<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> watchs<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> watchs<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span>
        watchs<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span>newValue<span class="token punctuation">,</span> item<span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token punctuation">(</span>watchs<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>handler <span class="token operator">&amp;&amp;</span> watchs<span class="token punctuation">[</span>item<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span>newValue<span class="token punctuation">,</span> item<span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="usestore"><a href="#usestore" class="header-anchor">#</a> useStore</h2> <blockquote><p>文件 render/store/*.js</p></blockquote> <p>store.js 状态库文件，实现非常简易(stat, set, get, subscribe)，具体见源码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在 set 中，在设置值的时候与 setData 一样，会有一个更新数组 updates</span>
    <span class="token comment">// 用于订阅回调使用</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token punctuation">}</span>
    <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于快应用限制，无法使用局部状态管理，所以只能把所有状态统一管理，
于是这里有 addStore.js 文件，进行各个 store 模块的整合。
还有一个 middleware.js 文件，用于各个 store 模块的调用，抛出 getState dispatch 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回 key 为 Root 的 store 模块的所有状态 </span>
<span class="token function">getState</span><span class="token punctuation">(</span><span class="token string">'Root'</span><span class="token punctuation">)</span>
<span class="token comment">// 调用 key 为 Root 的 store 模块的 setTest 方法，并传入值 1</span>
<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'Root/setTest'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>在管理状态的时候，有的状态往往需要进行缓存处理，那这时候就有 storage.js 文件，来做缓存的处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里将所有拿到的 store 模块，进行了一次订阅</span>
<span class="token comment">// 其实这里可以不把 storage 模块与 store 模块放在一起</span>
<span class="token comment">// 因为 storage 模块其实是一个工具类型，完全可以放出去，减少代码关联性</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span>
    Store<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">updates</span> <span class="token operator">=&gt;</span>
        <span class="token comment">// 在给定的需要缓存的 key 的列表中，匹配到对应的状态进行缓存</span>
        <span class="token function">useStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            key<span class="token punctuation">,</span>
            updates<span class="token punctuation">,</span>
            storage<span class="token operator">:</span> Store<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>storage<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>在应用进来的时候，需要去读取一遍缓存，然后进行同步，但是读缓存是异步的，
假如在缓存读取完成之前去操作 store 肯定是有问题的，所以需要一个状态准备阶段。
在文件 middleware.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 准备阶段，比如准备缓存</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>storeBeforeReadyQueue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> storeBeforeReadyQueue<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 准备完毕</span>
    storeReady <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 在准备完成之前被推入等待队列的回调，在完成之后执行</span>
    storeAfterReadyQueue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> storeAfterReadyQueue<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>光有准备阶段不能解决问题，因为 page/component 的生命周期是单独的流程，所以在 app.ux 新增了一个自定义的生命周期，
保证该生命周期执行的时候，store 是一定准备完成的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onInit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onPageInit <span class="token operator">&amp;&amp;</span> <span class="token function">storeReadyAfter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onPageInit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onShow'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onPageShow <span class="token operator">&amp;&amp;</span> <span class="token function">storeReadyAfter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onPageShow</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>store 的准备阶段耗时约为 100~300ms ，在有开屏页面的应用是可以接受的，但也可以优化，就是按需加载(在使用时去读取缓存)。</p> <p>在这时 store 的功能基本完成了，剩下的就是如何与页面进行绑定，于是有文件 useStore.js。
与页面数据的思路与 useComputed 一致，将使用的 key 写入到 data 里面，促使页面渲染。
然后在 onInit 的时候进行一次订阅更新</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onInit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getStateData<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 更新数据方法，id 用作优化赋值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">updateState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStateData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sync<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 订阅 store 更新</span>
    <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateState<span class="token punctuation">)</span>
    <span class="token comment">// 初始化时再走一遍数据赋值，以防在别的地方改变了但并未初始化造成的不同步</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> priority<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onDestroy'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getStateData<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 在销毁的时候取消订阅</span>
    <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateState<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updateState <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>到这里，整个状态的管理以及与页面的绑定就已经完成了，若需要其他功能，通过订阅的方式去扩展，基本能够完成支持。</p> <h2 id="usestat"><a href="#usestat" class="header-anchor">#</a> useStat</h2> <blockquote><p>文件 stat/*.js</p></blockquote> <p>埋点功能。由于埋点需要页面参数、页面行为路线，在这里需要有两个基本数据：页面行为路线、页面栈。</p> <p>关于页面的东西肯定离不开路由，所以有 render/router.js 文件，用于处理路由的拦截，一样通过钩子的形式，
对页面行为路线和页面栈进行修改(比如前进一个页面，就 push 一个页面信息)，再对离开页面的生命周期 onBackPress 进行一次代理，
使页面栈能够正确的跟随用户行为。处理页面行为路线、页面栈在 stat/stack.js 文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当使用 push 的时候也同时 push 一个页面栈、页面行为路线，其他同理</span>
<span class="token function">addRouteHooks</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addPageChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">updatePageStack</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在这时候拿到了正确的页面栈，但对于埋点来说还差页面的埋点信息，
所以这时候有一个 useStat.js 文件，来处理当前页面的埋点信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">useStat</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        page<span class="token operator">:</span> <span class="token string">'首页'</span><span class="token punctuation">,</span>
        pageParams<span class="token operator">:</span> <span class="token punctuation">{</span>
            xxx<span class="token operator">:</span> <span class="token number">123</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在之前的项目中，组件内的埋点都需要提取到页面来执行，因为需要页面的埋点信息，
但是现在，通过把埋点信息绑定到页面栈的方式，组件内的埋点可以直接从页面栈里面去拿，
从而达到埋点与页面解耦的目的，解放了大量的埋点劳动力。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在 onShow 的时候，将当前页面埋点信息的获取方式推入页面栈</span>
<span class="token function">updatePageStackLast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// statParams 这一条就是 useStat 传入的回调函数返回的值了</span>
    <span class="token keyword">const</span> statParams <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getStatDefaultParams <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatDefaultParams</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOwnPageParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">,</span>
        name<span class="token operator">:</span> pageName<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">?</span> pageName<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">.</span>page <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        id<span class="token punctuation">,</span>
        statParams<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里就完成了埋点与页面的解耦，可以在需要的地方直接埋点，而不用担心页面参数的问题。</p> <p>在埋点需要的参数里面，有父页面 parent 的参数，按照需求，父页面指的是上一个浏览的页面，
这里页面栈是无法满足这个需求的，所以才会有用户行为路线这个链条，
不管在用户是 push replace back 还是什么操作，都只需要 push 当前页面参数，
这样 parent 就只需要拿 用户行为路线 的最后一个值就行，但最后一个值需要在页面离开的时候更新一下，
保证拿到的是需要的埋点数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onHide'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> statParams <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getStatDefaultParams <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatDefaultParams</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOwnPageParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 页面离开的时候更新最后一个页面的参数</span>
    <span class="token function">updatePageChain</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        path<span class="token punctuation">,</span>
        name<span class="token operator">:</span> pageName<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">?</span> pageName<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">.</span>page <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        id<span class="token punctuation">,</span>
        statParams<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token operator">:</span> <span class="token string">'page'</span><span class="token punctuation">,</span> priority<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>到这里基础数据就已经解决了，那么只需要在 onShow onHide 的时候分别调用就解决了页面的展示隐藏埋点上报了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onShow'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 展示上报</span>
    <span class="token function">$stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token operator">:</span> <span class="token string">'page'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">addLifecycle</span><span class="token punctuation">(</span><span class="token string">'onHide'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 离开上报</span>
    <span class="token function">$stat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        target<span class="token operator">:</span> <span class="token string">'页面end'</span><span class="token punctuation">,</span>
        actionParams<span class="token operator">:</span> <span class="token punctuation">{</span> duration<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> outPage<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> useLast<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> target<span class="token operator">:</span> <span class="token string">'page'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>埋点需求有一个节点的展示埋点，这里通过节点的方法 onappear 来触发，通过传入 id 来进行上报限制。</p> <h2 id="usewebview"><a href="#usewebview" class="header-anchor">#</a> useWebview</h2> <blockquote><p>文件 webview/*.js</p></blockquote> <p>这一块是对 webview 页面/组件的统一交互支持，使用条件比较严格(尝试过web组件化，但是支持性不佳)，
详细的使用请参考 webview 页面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在模板上，这里的事件都是与 id 关联的，以 id 为前缀命名</span>
<span class="token comment">// useWebview 已经将这些方法写到了 page 中，所以不必再写，在 merge.js 文件</span>
<span class="token operator">&lt;</span>web id<span class="token operator">=</span><span class="token string">&quot;web&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;web-comp&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;{{websrc}}&quot;</span> trustedurl<span class="token operator">=</span><span class="token string">&quot;{{web_trustedurl}}&quot;</span> allowthirdpartycookies<span class="token operator">=</span><span class="token string">&quot;{{web_allowthirdpartycookies}}&quot;</span> onpagestart<span class="token operator">=</span><span class="token string">&quot;web_onPageStart&quot;</span> onpagefinish<span class="token operator">=</span><span class="token string">&quot;web_onPageFinish&quot;</span> ontitlereceive<span class="token operator">=</span><span class="token string">&quot;web_onTitleReceive&quot;</span> onerror<span class="token operator">=</span><span class="token string">&quot;web_onError&quot;</span> onmessage<span class="token operator">=</span><span class="token string">&quot;web_onMessage&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>web<span class="token operator">&gt;</span>

<span class="token comment">// 这里的 web 是 web 组件的 id 值</span>
<span class="token function">useWebview</span><span class="token punctuation">(</span><span class="token string">'web'</span><span class="token punctuation">)</span>
</code></pre></div><p>这里将所有的交互方法都写在了 message-to-web.js 文件中，交互过程在 merge.js 文件中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// web给快应用发送消息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'web给快应用发送消息'</span><span class="token punctuation">,</span> <span class="token function">decode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">decode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 空的信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'kyy_push_notice'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// web 组件接收到来自 web 的消息时，执行对应的方法</span>
        messageToWeb<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onPostMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'successCallback'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> arg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onPostMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'errorCallback'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> arg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">cancel</span><span class="token operator">:</span> <span class="token parameter">arg</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onPostMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'cancelCallback'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> arg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            page<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>data<span class="token punctuation">)</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">'方法不存在或执行错误'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onPostMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'errorCallback'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> error<span class="token operator">:</span> error<span class="token punctuation">.</span>stack <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_onPostMessage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 快应用给web发送消息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'快应用给web发送消息'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">const</span> web <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$element</span><span class="token punctuation">(</span>webId<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>web<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送内容</span>
        <span class="token comment">// 这里的 encode 编码比较重要，因为有的符号无法正常发送</span>
        web<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 给h5一个立即的答复，防止具体内容被吞</span>
        <span class="token comment">// 这里是因为在测试的过程中，发现有时候消息并不能及时的发送到 web 页面</span>
        <span class="token comment">// 通过尝试后，再发送一个空的交互，可以达到正常通信的效果</span>
        web<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'kyy_push_notice'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="实用工具"><a href="#实用工具" class="header-anchor">#</a> 实用工具</h2> <p>这里推荐一下非常实用的方法</p> <h3 id="addhook-gethook"><a href="#addhook-gethook" class="header-anchor">#</a> addHook getHook</h3> <blockquote><p>文件 utils/utils.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 处理钩子的函数，返回函数销毁当前钩子</span>
<span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">addHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        queue<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> current <span class="token operator">=</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> current<span class="token punctuation">.</span>id<span class="token operator">++</span><span class="token punctuation">,</span>
        callback<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    current<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> current<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> current<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHook</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>queue <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>callback<span class="token punctuation">)</span>

<span class="token comment">// 如何使用？</span>
<span class="token comment">// 添加钩子</span>
<span class="token function">addHook</span><span class="token punctuation">(</span><span class="token string">'&lt;key&gt;'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token comment">// 调用钩子</span>
<span class="token function">getHook</span><span class="token punctuation">(</span><span class="token string">'&lt;key&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>钩子的控制可以用在很多地方：用户信息改变时需要清除一些信息、添加桌面弹窗时需要展示提示弹窗等等</p> <h3 id="adddispatchqueue"><a href="#adddispatchqueue" class="header-anchor">#</a> addDispatchQueue</h3> <blockquote><p>文件 render/addDispatchQueue.js</p></blockquote> <p>这里也可以不是 dispatch 队列，只是随便起的名字，只要是个 promise 就行，非常实用。
比如 getUserInfo 方法，getUserInfo 在很多地方使用，但是不需要担心在多个地方同时调用引起的多个请求，
达到优化的目的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// dispatch队列</span>
<span class="token keyword">const</span> dispatchQueue <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dispatchRuning <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">dispatchRunQueue</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> dispatchQueue<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token punctuation">)</span> <span class="token keyword">return</span> dispatchRuning<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>

    dispatchRuning<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> current<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'runQueue'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token function">dispatchRunQueue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">start</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>dispatchRuning<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dispatchRunQueue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">addDispatchQueue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dispatchQueue<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> dispatchQueue<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        dispatchQueue<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            callback<span class="token punctuation">,</span>
            resolve<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">start</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="关于配置"><a href="#关于配置" class="header-anchor">#</a> 关于配置</h2> <p>有关应用的配置以及图片的配置，我都统一提取到了 project/*.js 文件中，
在跟进到新的包时，只需要拉一个新分支，然后修改文件里面的内容即可。</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>在这一个框架中，扮演最重要的角色其实就是生命周期，也就是 addLifecycle 方法，
在很多地方都可以使用，并且非常方便，侧面也说明了钩子的方便，所以在这个项目中，
我很多地方都使用了钩子，比如用户信息改变钩子、添加桌面弹窗钩子等等。
通过一个方法带动其他回调的方式，达到解耦的目的。</p> <p>其实在开始的时候是没有想到 addLifecycle 的方式的，只是单纯的一层一层的代理，
写着写着就会觉得理解困难，才想到使用这种方式来处理，只是没想到效果出乎意料的好。</p> <p>对于状态管理的思路也来自头条小程序，在那之前写的 redux 及 vuex 都太过繁琐，且难以理解。
但是假如一个状态管理只有 get set 的时候，就变得非常简单直接了，能够简化大量的垃圾代码(像 this.$store.dispatch 前面的 this.$store 也是垃圾代码，所以我放在了全局，解耦后直接 dispatch)。</p> <p>对于埋点这一块，将页面信息放到页面栈上面后简直好多了，再也不用担心埋点耦合的问题了，
当前页面调用的埋点传的一定是当前页面的埋点信息，可以写在组件内，写在 utils 中，写在web交互方法中，
就跟 store 一样，完全解耦。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">4/3/2020, 8:11:34 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mp/" class="prev">
        小程序
      </a></span> <span class="next"><a href="/other/">
        其他
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a79f5426.js" defer></script><script src="/assets/js/2.1fbd1c76.js" defer></script><script src="/assets/js/8.ed75f2d5.js" defer></script>
  </body>
</html>
